#!/usr/bin/env node
var fs          = require('fs');
var path        = require('path');
var spawn       = require('child_process').spawn;
var exec        = require('child_process').exec;
var args        = require('minimist')(process.argv.slice(2))._;
var watch       = require('watch');
var colorsTmpl  = require('colors');
var gorun;

// Make sure we have arguments
if (args.length <= 0 || args > 1) {
  console.error([
    'Use gomon like so:\n',
    'gomon myfile.go\n'.green,
    'or even:\n',
    'gomon *.go\n'.green
  ].join(''));
  process.exit(2);
}

// Discover work path
var firstArgDir = path.dirname(args[0]);
var mainDir = firstArgDir === '.' ? process.cwd() : firstArgDir;
var processName = path.basename(args[0].name, '.go');


watch.createMonitor(mainDir, function (monitor) {
  monitor.files['.go'];
  monitor.on("created", killAll);
  monitor.on("changed", killAll);
  monitor.on("removed", killAll);
});

function run () {
  console.log('go run'.green, args.join(', '));

  gorun = spawn('go', ['run'].concat(args));
  gorun.stdout.on('data', function (data) {
    console.log('stdout: ' + data);
  });
  gorun.stderr.on('data', function (data) {
    console.log('stderr: ' + data);
  });
}

function killAll () {
  console.log('>> restart'.red);
  exec('killall '+processName, function (err, stdout, stderr) {
    run();
  });
}

run();
